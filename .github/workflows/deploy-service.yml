name: Deploy MLOps Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-southeast-1
  PULUMI_STACK: ay4tu/mlops-pipeline/sandbox

jobs:
  # -------------------------------------------------
  # 1. TEST SERVICES
  # -------------------------------------------------
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ml-inference, data-ingestion]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies and run tests
        run: |
          cd services/${{ matrix.service }}
          pip install -r requirements.txt
          pip install pytest

          if [ -d "tests" ]; then
            pytest tests/ -v
          else
            python -c "from app import app; c=app.test_client(); r=c.get('/health'); assert r.status_code==200; print('Health check OK')"
          fi

  # -------------------------------------------------
  # 2. DEPLOY INFRA (PULUMI ONLY)
  # -------------------------------------------------
  deploy-infrastructure:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      instance_ip: ${{ steps.outputs.outputs.instance_ip }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Pulumi
        run: |
          curl -fsSL https://get.pulumi.com | sh
          echo "$HOME/.pulumi/bin" >> $GITHUB_PATH

      - name: Deploy infrastructure
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          cd infrastructure
          pip install -r requirements.txt
          pulumi login
          pulumi stack select ${{ env.PULUMI_STACK }} || pulumi stack init ${{ env.PULUMI_STACK }}
          pulumi up --yes

      - name: Get outputs
        id: outputs
        run: |
          cd infrastructure
          echo "instance_ip=$(pulumi stack output instance_public_ip)" >> $GITHUB_OUTPUT

  # -------------------------------------------------
  # 3. BUILD & PUSH IMAGES (DOCKER HUB)
  # -------------------------------------------------
  build-and-push:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service: [ml-inference, data-ingestion]

    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd services/${{ matrix.service }}

          if [ "${{ matrix.service }}" = "ml-inference" ]; then
            IMAGE_NAME=$DOCKERHUB_USERNAME/ml-inference
          else
            IMAGE_NAME=$DOCKERHUB_USERNAME/data-ingestion
          fi

          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker push $IMAGE_NAME:latest

  # -------------------------------------------------
  # 4. DEPLOY SERVICES TO EC2
  # -------------------------------------------------
  deploy-services:
    needs: [deploy-infrastructure, build-and-push]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          host: ${{ needs.deploy-infrastructure.outputs.instance_ip }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 30m
          envs: DOCKERHUB_USERNAME,DOCKERHUB_TOKEN
          script: |
            set -e

            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

            export ML_INFERENCE_IMAGE="$DOCKERHUB_USERNAME/ml-inference:latest"
            export DATA_INGESTION_IMAGE="$DOCKERHUB_USERNAME/data-ingestion:latest"

            docker pull $ML_INFERENCE_IMAGE
            docker pull $DATA_INGESTION_IMAGE

            cat <<EOF > /home/ubuntu/.env
            ML_INFERENCE_IMAGE=$ML_INFERENCE_IMAGE
            DATA_INGESTION_IMAGE=$DATA_INGESTION_IMAGE
            EOF

      - name: Copy docker-compose and configs to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ needs.deploy-infrastructure.outputs.instance_ip }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml,monitoring/"
          target: "/home/ubuntu"

      - name: Start services
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          host: ${{ needs.deploy-infrastructure.outputs.instance_ip }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 30m
          envs: DOCKERHUB_USERNAME,DOCKERHUB_TOKEN
          script: |
            set -e
            cd /home/ubuntu
            docker compose down || true
            docker compose up -d
